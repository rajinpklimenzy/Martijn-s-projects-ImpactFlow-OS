const p=()=>typeof process<"u"||typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://127.0.0.1:8050/api/v1/impactOS":"https://node-server.impact24x7.com/api/v1/impactOS",I=i=>{try{const t=new URL(i);return`${t.protocol==="https:"?"wss:":"ws:"}//${t.host}`}catch{return console.warn("[NOTIFICATION WS] Failed to parse API URL, using fallback"),"ws://127.0.0.1:8050"}};class h{constructor(t){this.ws=null,this.userId=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.reconnectTimer=null,this.listeners=new Map,this.isConnecting=!1,this.userId=t}connect(){return new Promise((t,e)=>{var l;if(((l=this.ws)==null?void 0:l.readyState)===WebSocket.OPEN){t();return}if(this.isConnecting){const s=setInterval(()=>{var c;this.isConnecting||(clearInterval(s),((c=this.ws)==null?void 0:c.readyState)===WebSocket.OPEN?t():e(new Error("Connection failed")))},100);return}this.isConnecting=!0;const o=p(),r=`${I(o)}/ws/notifications?userId=${encodeURIComponent(this.userId||"")}`;try{this.ws=new WebSocket(r),this.ws.onopen=()=>{console.log("[NOTIFICATION WS] Connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.reconnectDelay=1e3,t()},this.ws.onmessage=s=>{try{const c=JSON.parse(s.data);this.handleMessage(c)}catch(c){console.error("[NOTIFICATION WS] Error parsing message:",c)}},this.ws.onerror=s=>{console.error("[NOTIFICATION WS] WebSocket error:",s),this.isConnecting=!1,e(s)},this.ws.onclose=()=>{console.log("[NOTIFICATION WS] Connection closed"),this.isConnecting=!1,this.ws=null,this.attemptReconnect()}}catch(s){this.isConnecting=!1,e(s)}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[NOTIFICATION WS] Max reconnect attempts reached");return}if(this.reconnectTimer)return;this.reconnectAttempts++;const t=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),3e4);console.log(`[NOTIFICATION WS] Attempting to reconnect in ${t}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect().catch(e=>{console.error("[NOTIFICATION WS] Reconnect failed:",e)})},t)}handleMessage(t){t.type==="connected"?(console.log("[NOTIFICATION WS]",t.message),this.emit("connected",t)):t.type==="notification"?this.emit("notification",t.data):t.type==="error"&&(console.error("[NOTIFICATION WS] Error:",t.message),this.emit("error",t))}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){const o=this.listeners.get(t);o&&o.delete(e)}emit(t,e){const o=this.listeners.get(t);o&&o.forEach(a=>{try{a(e)}catch(r){console.error(`[NOTIFICATION WS] Error in listener for ${t}:`,r)}})}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.listeners.clear()}isConnected(){var t;return((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN}getUserId(){return this.userId}}let n=null;const f=i=>(n?n.getUserId()!==i&&(n.disconnect(),n=new h(i)):n=new h(i),n),d=()=>{n&&(n.disconnect(),n=null)};export{h as NotificationWebSocket,d as disconnectNotificationWebSocket,f as getNotificationWebSocket};
