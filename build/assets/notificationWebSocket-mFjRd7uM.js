const h=()=>typeof process<"u"||typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://127.0.0.1:8050/api/v1/impactOS":"https://node-server.impact24x7.com/api/v1/impactOS",p=i=>{try{const t=new URL(i);return`${t.protocol==="https:"?"wss:":"ws:"}//${t.host}`}catch{return console.warn("[NOTIFICATION WS] Failed to parse API URL, using fallback"),"ws://127.0.0.1:8050"}};class l{constructor(t){this.ws=null,this.userId=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.reconnectTimer=null,this.listeners=new Map,this.isConnecting=!1,this.userId=t}connect(){return new Promise((t,e)=>{if(this.ws?.readyState===WebSocket.OPEN){t();return}if(this.isConnecting){const s=setInterval(()=>{this.isConnecting||(clearInterval(s),this.ws?.readyState===WebSocket.OPEN?t():e(new Error("Connection failed")))},100);return}this.isConnecting=!0;const o=h(),c=`${p(o)}/ws/notifications?userId=${encodeURIComponent(this.userId||"")}`;try{this.ws=new WebSocket(c),this.ws.onopen=()=>{console.log("[NOTIFICATION WS] Connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.reconnectDelay=1e3,t()},this.ws.onmessage=s=>{try{const r=JSON.parse(s.data);this.handleMessage(r)}catch(r){console.error("[NOTIFICATION WS] Error parsing message:",r)}},this.ws.onerror=s=>{console.error("[NOTIFICATION WS] WebSocket error:",s),this.isConnecting=!1,e(s)},this.ws.onclose=()=>{console.log("[NOTIFICATION WS] Connection closed"),this.isConnecting=!1,this.ws=null,this.attemptReconnect()}}catch(s){this.isConnecting=!1,e(s)}})}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[NOTIFICATION WS] Max reconnect attempts reached");return}if(this.reconnectTimer)return;this.reconnectAttempts++;const t=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),3e4);console.log(`[NOTIFICATION WS] Attempting to reconnect in ${t}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect().catch(e=>{console.error("[NOTIFICATION WS] Reconnect failed:",e)})},t)}handleMessage(t){t.type==="connected"?(console.log("[NOTIFICATION WS]",t.message),this.emit("connected",t)):t.type==="notification"?this.emit("notification",t.data):t.type==="error"&&(console.error("[NOTIFICATION WS] Error:",t.message),this.emit("error",t))}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){const o=this.listeners.get(t);o&&o.delete(e)}emit(t,e){const o=this.listeners.get(t);o&&o.forEach(a=>{try{a(e)}catch(c){console.error(`[NOTIFICATION WS] Error in listener for ${t}:`,c)}})}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.listeners.clear()}isConnected(){return this.ws?.readyState===WebSocket.OPEN}getUserId(){return this.userId}}let n=null;const I=i=>(n?n.getUserId()!==i&&(n.disconnect(),n=new l(i)):n=new l(i),n),f=()=>{n&&(n.disconnect(),n=null)};export{l as NotificationWebSocket,f as disconnectNotificationWebSocket,I as getNotificationWebSocket};
